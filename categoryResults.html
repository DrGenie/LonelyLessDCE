<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results by Loneliness Category</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        .category-section {
            margin-top: 40px;
            padding: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        .data-section {
            margin-top: 20px;
        }
        .data-section h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }
        .data-section p, .data-section li {
            font-size: 1em;
            color: #34495e;
        }
        .data-section ul {
            list-style-type: disc;
            margin-left: 25px;
        }
        button {
            padding: 10px 15px;
            background-color: #27ae60;
            color: #ffffff;
            border: none;
            font-size: 1em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }
        button:hover {
            background-color: #1e8449;
            transform: translateY(-2px);
        }
        footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px;
            background-color: #3498db;
            color: #ffffff;
            font-size: 1.1em;
            border-radius: 0 0 12px 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Results by Loneliness Category</h1>

        <!-- Not Lonely Section -->
        <div class="category-section" id="notLonelySection">
            <h2>Not Lonely</h2>
            <div class="chart-container">
                <canvas id="notLonelyChart" aria-label="Doughnut chart showing uptake probability for Not Lonely category" role="img"></canvas>
            </div>
            <div class="data-section">
                <h3>Predicted Probability of Program Uptake:</h3>
                <p id="notLonelyProbability">--</p>
                <h3>Interpretation:</h3>
                <p id="notLonelyInterpretation">--</p>
                <h3>Your Selected Program Package:</h3>
                <ul id="notLonelyPackageList">
                    <!-- Selected attributes will be listed here -->
                </ul>
                <h3>Cost Analysis:</h3>
                <ul id="NotLonelyCostList">
                    <!-- Cost components will be listed here -->
                </ul>
                <p><strong>Total Estimated Cost:</strong> <span id="NotLonelyTotalCost">--</span> AUD</p>
                <h3>Benefit Analysis:</h3>
                <p><strong>Total Estimated Benefits:</strong> <span id="NotLonelyBenefits">--</span> AUD</p>
                <h3>Cost-Benefit Analysis:</h3>
                <p><strong>Net Benefit:</strong> <span id="NotLonelyNetBenefit">--</span> AUD</p>
                <p><strong>Benefit-Cost Ratio:</strong> <span id="NotLonelyBCR">--</span></p>
            </div>
            <div class="chart-container">
                <canvas id="notLonelyCBAChart" aria-label="Bar chart showing Cost-Benefit Analysis for Not Lonely category" role="img"></canvas>
            </div>
        </div>

        <!-- Moderately Lonely Section -->
        <div class="category-section" id="moderatelyLonelySection">
            <h2>Moderately Lonely</h2>
            <div class="chart-container">
                <canvas id="moderatelyLonelyChart" aria-label="Doughnut chart showing uptake probability for Moderately Lonely category" role="img"></canvas>
            </div>
            <div class="data-section">
                <h3>Predicted Probability of Program Uptake:</h3>
                <p id="moderatelyLonelyProbability">--</p>
                <h3>Interpretation:</h3>
                <p id="moderatelyLonelyInterpretation">--</p>
                <h3>Your Selected Program Package:</h3>
                <ul id="moderatelyLonelyPackageList">
                    <!-- Selected attributes will be listed here -->
                </ul>
                <h3>Cost Analysis:</h3>
                <ul id="ModeratelyLonelyCostList">
                    <!-- Cost components will be listed here -->
                </ul>
                <p><strong>Total Estimated Cost:</strong> <span id="ModeratelyLonelyTotalCost">--</span> AUD</p>
                <h3>Benefit Analysis:</h3>
                <p><strong>Total Estimated Benefits:</strong> <span id="ModeratelyLonelyBenefits">--</span> AUD</p>
                <h3>Cost-Benefit Analysis:</h3>
                <p><strong>Net Benefit:</strong> <span id="ModeratelyLonelyNetBenefit">--</span> AUD</p>
                <p><strong>Benefit-Cost Ratio:</strong> <span id="ModeratelyLonelyBCR">--</span></p>
            </div>
            <div class="chart-container">
                <canvas id="moderatelyLonelyCBAChart" aria-label="Bar chart showing Cost-Benefit Analysis for Moderately Lonely category" role="img"></canvas>
            </div>
        </div>

        <!-- Severely Lonely Section -->
        <div class="category-section" id="severelyLonelySection">
            <h2>Severely Lonely</h2>
            <div class="chart-container">
                <canvas id="severelyLonelyChart" aria-label="Doughnut chart showing uptake probability for Severely Lonely category" role="img"></canvas>
            </div>
            <div class="data-section">
                <h3>Predicted Probability of Program Uptake:</h3>
                <p id="severelyLonelyProbability">--</p>
                <h3>Interpretation:</h3>
                <p id="severelyLonelyInterpretation">--</p>
                <h3>Your Selected Program Package:</h3>
                <ul id="severelyLonelyPackageList">
                    <!-- Selected attributes will be listed here -->
                </ul>
                <h3>Cost Analysis:</h3>
                <ul id="SeverelyLonelyCostList">
                    <!-- Cost components will be listed here -->
                </ul>
                <p><strong>Total Estimated Cost:</strong> <span id="SeverelyLonelyTotalCost">--</span> AUD</p>
                <h3>Benefit Analysis:</h3>
                <p><strong>Total Estimated Benefits:</strong> <span id="SeverelyLonelyBenefits">--</span> AUD</p>
                <h3>Cost-Benefit Analysis:</h3>
                <p><strong>Net Benefit:</strong> <span id="SeverelyLonelyNetBenefit">--</span> AUD</p>
                <p><strong>Benefit-Cost Ratio:</strong> <span id="SeverelyLonelyBCR">--</span></p>
            </div>
            <div class="chart-container">
                <canvas id="severelyLonelyCBAChart" aria-label="Bar chart showing Cost-Benefit Analysis for Severely Lonely category" role="img"></canvas>
            </div>
        </div>

        <!-- Download All CBA Reports Button -->
        <button onclick="downloadAllCBAs()" aria-label="Download all Cost-Benefit Analysis reports as PDFs">Download All CBA Reports as PDFs</button>
    </div>

    <footer>
        <p>by Mesfin Genie, The University of Newcastle, Australia</p>
    </footer>

    <script>
        // Model Coefficients by Loneliness Categories based on Table 5
        const categories = {
            "Not Lonely": {
                ASC_alt1: -0.149,
                ASC_optout: 0.151,
                type_comm: 0.369,
                type_psych: -0.019,
                type_vr: -0.375,
                mode_virtual: -0.604,
                mode_hybrid: -0.289,
                freq_weekly: 0.759,
                freq_monthly: 0.540,
                dur_2hrs: 0.031,
                dur_4hrs: 0.243,
                dist_local: -0.041,
                dist_signif: -0.814,
                cost_cont: -0.034
            },
            "Moderately Lonely": {
                ASC_alt1: -0.145,
                ASC_optout: 0.074,
                type_comm: 0.532,
                type_psych: 0.178,
                type_vr: -0.204,
                mode_virtual: -0.320,
                mode_hybrid: -0.402,
                freq_weekly: 0.555,
                freq_monthly: 0.357,
                dur_2hrs: 0.322,
                dur_4hrs: 0.266,
                dist_local: 0.082,
                dist_signif: -0.467,
                cost_cont: -0.042
            },
            "Severely Lonely": {
                ASC_alt1: -0.028,
                ASC_optout: 0.160,
                type_comm: 0.734,
                type_psych: 0.317,
                type_vr: -0.567,
                mode_virtual: -0.353,
                mode_hybrid: -0.151,
                freq_weekly: 0.540,
                freq_monthly: 0.042,
                dur_2hrs: 0.157,
                dur_4hrs: 0.060,
                dist_local: 0.211,
                dist_signif: -0.185,
                cost_cont: -0.033
            }
        };

        // Cost Data remains the same as main script
        const costData = {
            type_comm: {
                personnel: 20000,
                materials: 2000,
                technology: 3000,
                facility: 5000,
                marketing: 5000,
                training: 1000,
                miscellaneous: 1000
            },
            type_psych: {
                personnel: 25000,
                materials: 1500,
                technology: 2000,
                facility: 4000,
                marketing: 4000,
                training: 800,
                miscellaneous: 1200
            },
            type_vr: {
                personnel: 18000,
                materials: 1000,
                technology: 5000,
                facility: 3000,
                marketing: 3000,
                training: 700,
                miscellaneous: 800
            },
            mode_virtual: {
                personnel: 5000,
                materials: 500,
                technology: 4000,
                facility: 0,
                marketing: 1000,
                training: 300,
                miscellaneous: 500
            },
            mode_hybrid: {
                personnel: 7000,
                materials: 800,
                technology: 4500,
                facility: 2000,
                marketing: 1200,
                training: 400,
                miscellaneous: 600
            },
            freq_weekly: {
                personnel: 10000,
                materials: 1200,
                technology: 1500,
                facility: 3000,
                marketing: 1500,
                training: 500,
                miscellaneous: 700
            },
            freq_monthly: {
                personnel: 8000,
                materials: 1000,
                technology: 1200,
                facility: 2500,
                marketing: 1300,
                training: 400,
                miscellaneous: 600
            },
            dur_2hrs: {
                personnel: 3000,
                materials: 500,
                technology: 800,
                facility: 1000,
                marketing: 700,
                training: 200,
                miscellaneous: 300
            },
            dur_4hrs: {
                personnel: 4000,
                materials: 700,
                technology: 1000,
                facility: 1500,
                marketing: 900,
                training: 300,
                miscellaneous: 400
            },
            cost_cont: {
                personnel: 0, // Assuming cost continuum is a scaling factor
                materials: 0,
                technology: 0,
                facility: 0,
                marketing: 0,
                training: 0,
                miscellaneous: 0
            },
            dist_local: {
                personnel: 5000,
                materials: 800,
                technology: 1000,
                facility: 2000,
                marketing: 1000,
                training: 300,
                miscellaneous: 500
            },
            dist_signif: {
                personnel: 6000,
                materials: 900,
                technology: 1100,
                facility: 2200,
                marketing: 1100,
                training: 350,
                miscellaneous: 550
            },
            // Add more attributes as needed
        };

        // Benefit Parameters
        const benefitPerPercent = 10000; // $10,000 AUD per 1% uptake probability

        // Cost-of-Living Multipliers by State
        let costOfLivingMultipliers = {
            NSW: 1.10, // New South Wales
            VIC: 1.05, // Victoria
            QLD: 1.00, // Queensland
            WA: 1.08,  // Western Australia
            SA: 1.02,  // South Australia
            TAS: 1.03, // Tasmania
            ACT: 1.15, // Australian Capital Territory
            NT: 1.07   // Northern Territory
        };

        // Function to fetch dynamic cost-of-living data from a JSON file
        async function fetchCostOfLivingData() {
            try {
                const response = await fetch('costOfLiving.json'); // Ensure this file is in your project directory
                if (!response.ok) {
                    throw new Error('Failed to load cost-of-living data.');
                }
                const data = await response.json();
                costOfLivingMultipliers = data;
                console.log('Cost-of-Living data loaded successfully:', costOfLivingMultipliers);
            } catch (error) {
                console.error('Error loading Cost-of-Living data:', error);
                alert('Failed to load Cost-of-Living data. Using default values.');
                // Default multipliers can remain as initially set
            }
        }

        // Call the fetch function on page load
        fetchCostOfLivingData();

        // Initialize Charts for Each Category
        const charts = {};

        function initializeCharts() {
            for (let category in categories) {
                // Uptake Probability Chart
                const ctx = document.getElementById(`${category.replace(" ", "")}Chart`).getContext('2d');
                charts[`${category}Chart`] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Uptake Probability', 'Remaining'],
                        datasets: [{
                            data: [0, 1],
                            backgroundColor: ['rgba(39, 174, 96, 0.6)', 'rgba(236, 240, 241, 0.3)'],
                            borderColor: ['rgba(39, 174, 96, 1)', 'rgba(236, 240, 241, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    color: '#34495e'
                                }
                            },
                            title: {
                                display: true,
                                text: `Predicted Probability of Program Uptake - ${category}`,
                                font: {
                                    size: 18
                                },
                                color: '#2c3e50'
                            }
                        }
                    }
                });

                // Cost-Benefit Analysis Chart
                const cbaCtx = document.getElementById(`${category.replace(" ", "")}CBAChart`).getContext('2d');
                charts[`${category}CBAChart`] = new Chart(cbaCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Total Costs', 'Total Benefits'],
                        datasets: [{
                            label: 'Amount (AUD)',
                            data: [0, 0],
                            backgroundColor: [
                                'rgba(231, 76, 60, 0.6)', // Red for Costs
                                'rgba(39, 174, 96, 0.6)'   // Green for Benefits
                            ],
                            borderColor: [
                                'rgba(231, 76, 60, 1)',
                                'rgba(39, 174, 96, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `Cost-Benefit Analysis - ${category}`,
                                font: {
                                    size: 18
                                },
                                color: '#2c3e50'
                            }
                        }
                    }
                });
            }
        }

        // Call initializeCharts on window load
        window.onload = function() {
            if (!window.opener || window.opener.closed) {
                alert("Unable to access data from the main window. Please open this page through the 'View Results by Loneliness Category' button.");
                return;
            }
            initializeCharts();
            displayAllCategories();
        }

        // Function to calculate probability for a given category
        function calculateProbabilityCategory(category) {
            const coeff = categories[category];

            // Fetch selections from the main window
            const state = window.opener.document.getElementById('state_select').value;
            const adjustCosts = window.opener.document.getElementById('adjust_costs').value;
            const cost_cont = parseFloat(window.opener.document.getElementById('cost_cont').value);
            const dist_signif = parseFloat(window.opener.document.getElementById('dist_signif').value);
            const dist_local = parseFloat(window.opener.document.getElementById('dist_local').value);
            const freq_monthly = parseFloat(window.opener.document.getElementById('freq_monthly').value);
            const freq_weekly = parseFloat(window.opener.document.getElementById('freq_weekly').value);
            const mode_virtual = parseFloat(window.opener.document.getElementById('mode_virtual').value);
            const mode_hybrid = parseFloat(window.opener.document.getElementById('mode_hybrid').value);
            const dur_2hrs = parseFloat(window.opener.document.getElementById('dur_2hrs').value);
            const dur_4hrs = parseFloat(window.opener.document.getElementById('dur_4hrs').value);
            const type_comm = parseFloat(window.opener.document.getElementById('type_comm').value);
            const type_psych = parseFloat(window.opener.document.getElementById('type_psych').value);
            const type_vr = parseFloat(window.opener.document.getElementById('type_vr').value);

            // Validate that if 'Adjust Costs for Living Expenses' is 'Yes', a state is selected
            if (adjustCosts === 'yes' && !state) {
                alert("Please select a state if you choose to adjust costs for living expenses.");
                return "--";
            }

            // Calculate U_alt1 with Cost-of-Living Adjustment
            let adjusted_cost_cont = cost_cont; // Initialize adjusted cost_cont

            if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                adjusted_cost_cont = cost_cont * costOfLivingMultipliers[state];
            }

            let U_alt1 = coeff.ASC_alt1 +
                        coeff.type_comm * type_comm +
                        coeff.type_psych * type_psych +
                        coeff.type_vr * type_vr +
                        coeff.mode_virtual * mode_virtual +
                        coeff.mode_hybrid * mode_hybrid +
                        coeff.freq_weekly * freq_weekly +
                        coeff.freq_monthly * freq_monthly +
                        coeff.dur_2hrs * dur_2hrs +
                        coeff.dur_4hrs * dur_4hrs +
                        coeff.dist_local * dist_local +
                        coeff.dist_signif * dist_signif +
                        coeff.cost_cont * adjusted_cost_cont;

            // Calculate U_optout
            const U_optout = 0.131; // From Table 3

            // Calculate P_alt1 using the logistic function
            const exp_U_alt1 = Math.exp(U_alt1);
            const exp_U_optout = Math.exp(U_optout);
            const P_alt1 = exp_U_alt1 / (exp_U_alt1 + exp_U_optout);

            // Ensure P_alt1 is between 0 and 1
            const P_final = Math.min(Math.max(P_alt1, 0), 1);

            return P_final;
        }

        // Function to generate program package list with user-friendly labels for a given category
        function generateProgramPackageCategory(category) {
            const coeff = categories[category];
            const form = window.opener.document.getElementById('decisionForm');
            const selects = form.getElementsByTagName('select');
            const selectedAttributes = [];

            for (let select of selects) {
                if (select.id === 'state_select' || select.id === 'adjust_costs') {
                    continue; // Skip state and adjust costs selections
                }
                if (select.value === "1") {
                    let label = select.previousElementSibling.innerText;
                    label = label.replace(':', '').trim();
                    const value = select.options[select.selectedIndex].innerText;
                    selectedAttributes.push(`${label}: ${value}`);
                }
            }

            // Generate HTML list items
            let listItems = '';
            selectedAttributes.forEach(item => {
                listItems += `<li>${item}</li>`;
            });
            return listItems;
        }

        // Function to calculate total cost with state adjustment for a category
        function calculateTotalCostCategory(category) {
            const coeff = categories[category];
            const form = window.opener.document.getElementById('decisionForm');
            const selects = form.getElementsByTagName('select');
            let totalCost = 0;

            for (let select of selects) {
                if (select.id === 'state_select' || select.id === 'adjust_costs') {
                    continue; // Skip state and adjust costs selections
                }
                if (select.value === "1") {
                    const costs = costData[select.id];
                    for (let key in costs) {
                        totalCost += costs[key];
                    }
                }
            }

            // Fetch state and adjustCosts
            const state = window.opener.document.getElementById('state_select').value;
            const adjustCosts = window.opener.document.getElementById('adjust_costs').value;

            // Apply cost-of-living multiplier if applicable
            if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                totalCost = totalCost * costOfLivingMultipliers[state];
            }

            return { totalCost, grandTotal: totalCost };
        }

        // Function to calculate benefits based on probability
        function calculateBenefits(probability) {
            const benefit = probability * 100 * benefitPerPercent;
            return benefit;
        }

        // Function to display all categories
        function displayAllCategories() {
            for (let category in categories) {
                const P_final = calculateProbabilityCategory(category);
                const benefits = calculateBenefits(P_final);
                const state = window.opener.document.getElementById('state_select').value;
                const adjustCosts = window.opener.document.getElementById('adjust_costs').value;
                const cost_cont = parseFloat(window.opener.document.getElementById('cost_cont').value);
                const dist_signif = parseFloat(window.opener.document.getElementById('dist_signif').value);
                const dist_local = parseFloat(window.opener.document.getElementById('dist_local').value);
                const freq_monthly = parseFloat(window.opener.document.getElementById('freq_monthly').value);
                const freq_weekly = parseFloat(window.opener.document.getElementById('freq_weekly').value);
                const mode_virtual = parseFloat(window.opener.document.getElementById('mode_virtual').value);
                const mode_hybrid = parseFloat(window.opener.document.getElementById('mode_hybrid').value);
                const dur_2hrs = parseFloat(window.opener.document.getElementById('dur_2hrs').value);
                const dur_4hrs = parseFloat(window.opener.document.getElementById('dur_4hrs').value);
                const type_comm = parseFloat(window.opener.document.getElementById('type_comm').value);
                const type_psych = parseFloat(window.opener.document.getElementById('type_psych').value);
                const type_vr = parseFloat(window.opener.document.getElementById('type_vr').value);

                // Calculate total cost
                let adjusted_cost_cont = cost_cont;
                if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                    adjusted_cost_cont = cost_cont * costOfLivingMultipliers[state];
                }

                const coeff = categories[category];
                let totalCost = 0;
                for (let key in coeff) {
                    if (costData[key]) {
                        totalCost += costData[key].personnel +
                                     costData[key].materials +
                                     costData[key].technology +
                                     costData[key].facility +
                                     costData[key].marketing +
                                     costData[key].training +
                                     costData[key].miscellaneous;
                    }
                }

                // Apply cost-of-living multiplier
                if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                    totalCost = totalCost * costOfLivingMultipliers[state];
                }

                displayCategoryData(category, P_final, benefits, totalCost);
            }
        }

        // Function to display data for a specific category
        function displayCategoryData(category, P_final, benefits, totalCost) {
            // Update Probability
            document.getElementById(`${category.replace(" ", "")}Probability`).innerText = (P_final * 100).toFixed(2) + '%';

            // Update Interpretation
            const interpretation = generateInterpretationsCategory(P_final, category);
            document.getElementById(`${category.replace(" ", "")}Interpretation`).innerHTML = interpretation;

            // Update Program Package
            const packageList = generateProgramPackageCategory(category);
            document.getElementById(`${category.replace(" ", "")}PackageList`).innerHTML = packageList;

            // Update Cost Analysis
            const costResults = calculateTotalCostCategory(category);
            displayCosts(category, costResults);

            // Update Benefits
            displayBenefits(category, benefits);

            // Display Cost-Benefit Analysis
            displayCBA(category, costResults.grandTotal, benefits);

            // Update Charts
            updateCategoryCharts(category, P_final, benefits, costResults.grandTotal);
        }

        // Function to generate brief interpretations for categories
        function generateInterpretationsCategory(probability, category) {
            let interpretation = '';

            if (probability < 0.3) {
                interpretation = `<p><strong>${category}:</strong> Your selected support programs have a low probability of uptake (<30%). This suggests that the current configuration may not be attractive to older adults. Consider revising the program features to better meet the needs and preferences of your target population.</p>`;
            } else if (probability >= 0.3 && probability < 0.7) {
                interpretation = `<p><strong>${category}:</strong> Your selected support programs have a moderate probability of uptake (30%-70%). While there is potential interest, there is room for improvement. Enhancing certain program features could increase engagement and participation rates.</p>`;
            } else {
                interpretation = `<p><strong>${category}:</strong> Your selected support programs have a high probability of uptake (>70%). This indicates strong acceptance and interest from older adults. Maintaining and promoting these program features is recommended to maximize impact.</p>`;
            }

            return interpretation;
        }

        // Function to calculate total cost with state adjustment for a category
        function calculateTotalCostCategory(category) {
            const form = window.opener.document.getElementById('decisionForm');
            const selects = form.getElementsByTagName('select');
            let totalCost = 0;

            for (let select of selects) {
                if (select.id === 'state_select' || select.id === 'adjust_costs') {
                    continue; // Skip state and adjust costs selections
                }
                if (select.value === "1") {
                    const costs = costData[select.id];
                    for (let key in costs) {
                        totalCost += costs[key];
                    }
                }
            }

            // Fetch state and adjustCosts
            const state = window.opener.document.getElementById('state_select').value;
            const adjustCosts = window.opener.document.getElementById('adjust_costs').value;

            // Apply cost-of-living multiplier if applicable
            if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                totalCost = totalCost * costOfLivingMultipliers[state];
            }

            return { totalCost, grandTotal: totalCost };
        }

        // Function to display cost information
        function displayCosts(category, costResults) {
            const { totalCost, grandTotal } = costResults;
            const costList = document.getElementById(`${category}CostList`);
            const totalCostDisplay = document.getElementById(`${category}TotalCost`);
            
            // Clear Previous Costs
            costList.innerHTML = '';
            
            // Populate Cost Components
            const selectedAttributes = getSelectedAttributesCategory(category);
            selectedAttributes.forEach(attr => {
                if (costData[attr]) {
                    for (let key in costData[attr]) {
                        if (costData[attr][key] > 0) {
                            const listItem = document.createElement('li');
                            listItem.innerText = `${capitalizeFirstLetter(key)}: \$${costData[attr][key].toLocaleString()}`;
                            costList.appendChild(listItem);
                        }
                    }
                }
            });

            // Display Grand Total
            totalCostDisplay.innerText = grandTotal.toLocaleString();
        }

        // Function to display benefits
        function displayBenefits(category, benefits) {
            const benefitsDisplay = document.getElementById(`${category}Benefits`);
            benefitsDisplay.innerText = benefits.toLocaleString();
        }

        // Function to display Cost-Benefit Analysis
        function displayCBA(category, totalCost, benefits) {
            const netBenefitDisplay = document.getElementById(`${category}NetBenefit`);
            const bcrDisplay = document.getElementById(`${category}BCR`);

            const netBenefit = benefits - totalCost;
            const bcr = benefits / totalCost;

            netBenefitDisplay.innerText = netBenefit.toLocaleString();
            bcrDisplay.innerText = bcr.toFixed(2);
        }

        // Function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Function to get selected attributes for a category (from main window)
        function getSelectedAttributesCategory(category) {
            const form = window.opener.document.getElementById('decisionForm');
            const selects = form.getElementsByTagName('select');
            const attributes = [];
            for (let select of selects) {
                if (select.id === 'state_select' || select.id === 'adjust_costs') {
                    continue; // Skip state and adjust costs selections
                }
                if (select.value === "1") {
                    attributes.push(select.id);
                }
            }
            return attributes;
        }

        // Function to update charts for a specific category
        function updateCategoryCharts(category, P_final, benefits, totalCost) {
            // Uptake Probability Chart
            charts[`${category}Chart`].data.datasets[0].data = [P_final, 1 - P_final];
            // Update the Uptake Probability chart color based on probability
            if (P_final < 0.3) {
                charts[`${category}Chart`].data.datasets[0].backgroundColor = ['rgba(231, 76, 60, 0.6)', 'rgba(236, 240, 241, 0.3)']; // Red and Light Gray
                charts[`${category}Chart`].data.datasets[0].borderColor = ['rgba(231, 76, 60, 1)', 'rgba(236, 240, 241, 1)'];
            } else if (P_final >= 0.3 && P_final < 0.7) {
                charts[`${category}Chart`].data.datasets[0].backgroundColor = ['rgba(241, 196, 15, 0.6)', 'rgba(236, 240, 241, 0.3)']; // Yellow and Light Gray
                charts[`${category}Chart`].data.datasets[0].borderColor = ['rgba(241, 196, 15, 1)', 'rgba(236, 240, 241, 1)'];
            } else {
                charts[`${category}Chart`].data.datasets[0].backgroundColor = ['rgba(39, 174, 96, 0.6)', 'rgba(236, 240, 241, 0.3)']; // Green and Light Gray
                charts[`${category}Chart`].data.datasets[0].borderColor = ['rgba(39, 174, 96, 1)', 'rgba(236, 240, 241, 1)'];
            }
            charts[`${category}Chart`].update();

            // Cost-Benefit Analysis Chart
            charts[`${category}CBAChart`].data.datasets[0].data = [totalCost, benefits];
            charts[`${category}CBAChart`].update();
        }

        // Function to download all CBA reports as PDFs
        function downloadAllCBAs() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPosition = 10;

            for (let category in categories) {
                const P_final = calculateProbabilityCategory(category);
                const benefits = calculateBenefits(P_final);
                const state = window.opener.document.getElementById('state_select').value;
                const adjustCosts = window.opener.document.getElementById('adjust_costs').value;
                const cost_cont = parseFloat(window.opener.document.getElementById('cost_cont').value);
                const dist_signif = parseFloat(window.opener.document.getElementById('dist_signif').value);
                const dist_local = parseFloat(window.opener.document.getElementById('dist_local').value);
                const freq_monthly = parseFloat(window.opener.document.getElementById('freq_monthly').value);
                const freq_weekly = parseFloat(window.opener.document.getElementById('freq_weekly').value);
                const mode_virtual = parseFloat(window.opener.document.getElementById('mode_virtual').value);
                const mode_hybrid = parseFloat(window.opener.document.getElementById('mode_hybrid').value);
                const dur_2hrs = parseFloat(window.opener.document.getElementById('dur_2hrs').value);
                const dur_4hrs = parseFloat(window.opener.document.getElementById('dur_4hrs').value);
                const type_comm = parseFloat(window.opener.document.getElementById('type_comm').value);
                const type_psych = parseFloat(window.opener.document.getElementById('type_psych').value);
                const type_vr = parseFloat(window.opener.document.getElementById('type_vr').value);

                // Calculate total cost
                let adjusted_cost_cont = cost_cont;
                if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                    adjusted_cost_cont = cost_cont * costOfLivingMultipliers[state];
                }

                const coeff = categories[category];
                let totalCost = 0;
                for (let key in coeff) {
                    if (costData[key]) {
                        totalCost += costData[key].personnel +
                                     costData[key].materials +
                                     costData[key].technology +
                                     costData[key].facility +
                                     costData[key].marketing +
                                     costData[key].training +
                                     costData[key].miscellaneous;
                    }
                }

                // Apply cost-of-living multiplier
                if (adjustCosts === 'yes' && state && costOfLivingMultipliers[state]) {
                    totalCost = totalCost * costOfLivingMultipliers[state];
                }

                const netBenefit = benefits - totalCost;
                const bcr = benefits / totalCost;

                doc.setFontSize(16);
                doc.text(`Cost-Benefit Analysis Report - ${category}`, 10, yPosition);
                yPosition += 10;
                doc.setFontSize(12);
                doc.text(`Selected State: ${state ? state : 'N/A'}`, 10, yPosition);
                yPosition += 10;
                doc.text(`Adjust Costs for Living Expenses: ${adjustCosts === 'yes' ? 'Yes' : 'No'}`, 10, yPosition);
                yPosition += 10;
                doc.text(`Total Estimated Cost: $${totalCost.toLocaleString()} AUD`, 10, yPosition);
                yPosition += 10;
                doc.text(`Total Estimated Benefits: $${benefits.toLocaleString()} AUD`, 10, yPosition);
                yPosition += 10;
                doc.text(`Net Benefit: $${netBenefit.toLocaleString()} AUD`, 10, yPosition);
                yPosition += 10;
                doc.text(`Benefit-Cost Ratio: ${bcr.toFixed(2)}`, 10, yPosition);
                
                yPosition += 20;

                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 10;
                }
            }

            doc.save('All_CBA_Reports.pdf');

            alert("All Cost-Benefit Analysis reports downloaded successfully!");
        }
    </script>
</body>
</html>
